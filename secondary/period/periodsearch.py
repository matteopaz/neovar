import pandas as pd
from get_period import get_period
from joblib import Parallel, delayed
import os
import psutil
import time

# SLURM_JOB_ID = os.getenv("SLURM_JOB_ID")
# SLURM_JOB_NAME = os.getenv("SLURM_JOB_NAME")
# SLURM_ARRAY_TASK_N = int(os.getenv("SLURM_ARRAY_TASK_ID"))
# SLURM_ARRAY_TASK_COUNT = int(os.getenv("SLURM_ARRAY_TASK_COUNT"))
# TOTAL_TASKS = 12288
# SLURM_ARRAY_TASK_N = 13
# SLURM_ARRAY_TASK_COUNT = 20
# CHUNK_SIZE = TOTAL_TASKS // SLURM_ARRAY_TASK_COUNT
# partitions_to_do = range(SLURM_ARRAY_TASK_N * CHUNK_SIZE, (SLURM_ARRAY_TASK_N + 1) * CHUNK_SIZE)

# partitions_to_do = [7637, 9493, 10786, 3984, 3942, 3625, 3306, 3946, 3251, 3516, 3645, 9479, 9452, 3506, 3900, 7436, 10315, 7760, 7547, 7761, 9444, 9503, 9807, 3315, 9730, 3956, 9526, 3259, 3290, 9445, 3526, 9415, 3294, 10502, 3254, 9822, 3564, 10328, 3955, 3495, 3470, 3467, 10792, 10285, 8283, 3649, 9431, 7439, 7353, 3279, 10833, 12027, 8321, 10750, 10370, 3482, 3554, 8328, 3510, 3256, 10329, 7636, 3228, 9501, 9488, 9290, 9450, 12001, 9426, 9790, 9434, 9437, 9799, 9793, 9803, 9455, 3313, 9808, 3620, 7960, 10332, 3253, 3629, 12006, 10802, 3252, 3569, 3637, 10784, 9804, 3915, 7433, 9815, 3230, 9524, 9339, 9536, 9379, 3492, 8010, 3888, 9409, 3572, 9449, 3581, 3940, 10318, 9337, 3899, 8257, 10722, 3275, 10794, 10797, 10747, 3937, 9453, 3562, 10783, 3689, 7764, 3867, 3291, 7252, 9413, 3248, 8036, 10822, 9424, 3513, 3499, 8285, 3312, 11992, 3954, 3575, 3643, 9427, 10494, 3224, 3297, 7407, 9454, 3664, 7356, 3303, 10763, 3635, 9377, 3646, 7546, 9443, 9816, 3519, 10726, 3498, 3691, 9420, 10789, 10668, 7473, 3653, 10825, 9451, 3567, 3945, 3922, 3682, 3693, 9308, 3861, 10727, 3227, 8264, 3694, 8055, 11952, 8054, 8324, 7331, 3638, 7529, 9805, 10882, 10665, 3710, 3647, 7400, 3497, 3616, 3632, 9327, 9795, 8051, 3231, 3939, 9283, 10790, 3904, 9322, 10513, 10881, 9410, 3886, 3617, 7535, 10286, 3239, 9289, 3707, 3580, 3913, 3644, 3680, 9319, 7939, 10815, 9425, 9810, 9320, 3877, 7633, 9325, 10785, 3641, 3930, 7418, 8330, 3874, 3873, 10832, 3876, 3901, 3891, 3706, 3704, 3872, 3889, 7438, 7765, 10880, 9464, 3881, 10291, 11956, 9616, 3316, 4033, 10293, 3639, 3894, 10743, 10739, 8012, 3711, 3879, 10767, 9331, 8258, 3878, 9411, 10824, 9797, 3875, 9435, 3512, 7401, 3566, 11953, 3619, 3866, 7961, 9317, 10821, 3905, 11918, 10800, 3884, 3844, 8270, 8011, 12013, 7429, 3652, 3882, 3515, 8014, 9441, 10294, 3594, 9284, 8308, 7639, 3698, 9430, 10788, 3690, 10782, 7943, 3263, 3610, 10369, 3860, 7478, 10766, 8282, 3301, 10801, 10491, 9505, 7964, 9330, 10287, 10742, 10774, 7528, 3633, 10772, 3296, 3856, 10765, 7334, 9306, 3578, 9417, 3212, 10296, 9817, 10336, 3605, 3687, 7254, 3708, 3845, 10319, 3209, 9438, 3906, 7472, 3573, 9428, 9318, 11912, 9640, 9809, 9324, 9321, 10516, 12003, 3599, 9466, 7936, 3855, 9299, 9313, 10777, 3880, 10795, 10673, 9470, 12015, 3507, 10776, 3739, 3870, 9463, 3895, 9813, 10725, 7647, 9419, 7965, 11959, 3570, 3565, 3233, 3859, 3846, 10779, 8027, 8052, 3238, 10664, 10379, 3681, 3648, 8031, 10372, 9467, 9307, 3245, 8013, 3865, 3611, 10744, 3925, 7644, 3857, 3684, 3214, 3615, 8271, 10724, 9818, 10764, 8008, 11940, 3918, 7330, 3262, 10503, 10514, 3232, 10400, 3863, 7634, 10663, 3571, 10773, 10771, 3908, 3208, 8450, 7641, 9315, 10337, 3592, 10402, 11958, 10721, 3669, 10677, 3896, 3215, 10770, 7632, 3921, 7405, 7248, 8024, 8025, 3850, 9298, 9286, 10517, 3843, 10720, 3609, 10781, 7419, 9295, 7461, 3868, 3677, 8028, 3849, 9310, 7435, 10662, 7347, 10775, 10780, 10401, 9811, 10676, 10378, 9285, 10493, 10374, 7646, 9440, 3847, 9297, 3910, 10331, 7635, 7954, 7335, 10820, 9303, 9376, 8003, 10478, 7475, 9316, 3659, 10477, 3853, 10475, 9484, 8006, 9343, 8259, 7623, 10375, 10818, 8029, 7346, 10479, 3244, 8007, 3912, 7350, 7937, 10759, 7531, 8002, 11942, 9292, 8018, 3247, 3650, 12014, 11954, 10377, 3593, 3596, 3858, 9477, 10738, 10659, 9301, 8265, 10816, 3852, 3668, 10334, 3579, 9465, 10740, 3235, 10474, 7669, 10560, 3563, 10505, 3916, 10672, 7621, 3576, 9378, 9478, 7423, 10508, 7959, 9471, 9462, 7416, 9287, 3907, 7622, 10737, 3601, 3654, 11914, 7955, 10373, 7395, 3612, 3892, 7422, 7620, 10476, 7530, 3671, 3651, 11915, 10762, 10340, 7434, 9334, 7251, 9812, 7484, 10761, 10382, 12009, 7328, 10408, 7617, 10380, 8000, 9332, 3917, 3246, 3597, 8284, 3241, 7953, 7592, 7668, 8019, 10489, 7941, 3665, 7616, 3613, 7598, 9326, 10758, 10768, 3614, 3871, 7474, 7595, 3662, 10561, 10486, 10431, 7608, 10745, 10302, 9384, 11965, 10300, 9468, 7394, 3685, 7554, 3864, 7250, 9472, 8022, 7599, 7957, 7596, 10702, 7351, 10482, 3657, 3607, 10384, 7237, 7377, 7457, 10338, 7486, 10381, 7561, 8023, 7414, 10658, 9340, 10385, 7593, 10509, 3577, 7417, 3658, 7629, 10471, 7619, 8004, 7376, 7420, 12008, 7480, 10386, 10518, 3840, 3603, 3586, 11937, 7421, 10472, 7573, 3606, 8001, 10657, 3679, 10806, 10403, 7665, 7610, 3678, 3587, 7591, 7586, 9506, 3655, 11964, 7564, 7642, 10410, 10655, 7614, 7611, 3660, 3656, 7483, 7463, 7275, 10470, 7628, 7332, 7399, 7274, 10661, 7260, 10427, 7229, 3696, 10651, 10714, 8005, 7597, 9342, 12011, 7228, 10388, 10484, 3591, 7590, 10660, 3842, 10485, 10715, 7225, 8262, 10698, 7236, 7584, 10303, 3240, 10301, 7658, 10635, 10757, 7410, 10339, 10387, 8268, 9311, 10429, 7578, 11948, 7664, 7618, 7462, 3590, 7631, 7602, 10392, 7230, 7231, 11939, 7219, 7587, 10520, 10342, 10481, 11960, 3869, 10634, 10353, 7408, 8016, 3589, 3667, 3243, 7412, 11936, 10542, 7380, 10718, 7572, 7387, 7218, 7469, 10639, 10608, 7397, 7263, 7382, 7279, 10638, 11949, 3585, 3670, 7667, 10356, 10519, 3675, 10650, 10344, 10507, 10609, 7625, 7227, 7224, 7612, 10652, 7659, 7222, 10611, 10343, 8017, 7677, 8020, 10467, 7200, 7365, 7409, 7413, 7216, 9335, 10389, 7459, 10648, 7396, 7676, 3666, 3584, 10428, 10653, 7653, 3661, 10752, 10562, 10553, 10345, 7217, 7345, 7390, 7555, 10466, 7588, 9481, 7306, 7213, 10463, 8021, 7630, 10348, 12010, 7273, 7207, 7239, 11938, 7662, 9475, 7233, 10426, 3242, 7202, 10406, 10354, 7201, 10595, 10610, 7212, 3676, 10700, 3588, 10637, 7209, 7348, 10646, 10405, 7579, 10647, 7223, 11967, 7392, 10565, 10613, 7666, 9476, 7204, 10524, 7393, 7560, 10598, 10394, 10543, 7468, 10528, 7257, 10563, 7679, 8276, 10510, 7567, 7206, 7458, 7290, 10615, 10469, 10697, 8281, 10521, 7203, 7624, 10557, 7375, 11945, 10696, 10712, 7651, 10358, 7604, 10423, 7220, 7182, 7374, 10594, 10525, 3672, 7226, 10690, 3673, 7208, 10450, 7364, 7179, 10393, 7262, 9473, 7652, 7656, 7307, 10347, 7654, 10756, 10612, 7471, 10539, 10552, 10390, 7381, 10554, 7373, 10511, 7349, 9333, 7678, 7605, 10451, 7371, 3663, 10694, 9482, 11966, 8323, 7369, 7391, 9474, 10462, 9504, 10713, 7562, 10691, 7285, 7650, 10642, 10411, 7582, 10452, 10360, 7672, 7385, 10444, 10631, 7566, 7563, 7361, 7674, 7648, 7372, 7574, 10529, 7661, 7379, 10522, 10415, 7626, 10596, 7675, 7606, 10350, 10568, 7660, 7657, 7649, 7370, 10422, 10420, 10621, 7276, 7568, 10468, 7607, 10442, 10433, 10445, 10419, 7178, 11963, 7266, 7214, 7663, 10425, 7256, 7368, 7389, 10753, 10412, 3674, 10688, 10551, 7210, 7601, 10530, 7465, 10754, 7215, 11944, 7378, 7232, 10576, 7183, 7600, 10523, 10421, 7360, 10569, 10566, 10574, 11951, 10439, 7388, 10706, 10572, 7583, 10458, 10583, 10593, 7576, 7194, 10443, 8278, 10580, 10645, 7366, 10361, 10424, 10454, 10581, 10582, 7580, 10550, 7289, 10413, 7557, 10592, 10579, 10716, 10625, 10571, 7558, 10575, 10577, 7322, 10464, 7367, 7316, 7294, 7311, 10567, 7362, 10532, 11950, 10465, 10399, 7363, 10586, 7284, 10526, 7195, 7552, 10414, 10570, 10446, 7287, 10555, 10407, 7470, 10434, 10456, 10440, 7235, 10364, 7577, 7245, 7295, 10573, 7313, 10692, 10689, 10396, 10585, 10591, 7259, 7292, 10395, 7288, 7277, 7221, 10590, 7258, 10587, 10547, 10644, 10391, 10541, 7312, 7464, 10449, 10549, 7323, 11946, 10438, 10640, 10455, 10641, 7570, 10436, 7189, 10628, 10707, 7559, 10623, 7267, 10578, 7281, 10365, 10629, 10617, 10531, 10546, 10534, 10362, 10533, 7325, 10457, 7324, 10558, 7283, 10535, 7282, 7293, 10435, 10460, 10544, 10693, 10606, 10626, 7309, 10367, 10461, 7319, 10398, 7172, 7270, 10448, 10605, 7286, 7244, 10602, 10540, 10548, 7180, 10717, 8269, 7556, 10536, 7466, 7247, 10559, 7168, 7308, 7177, 10616, 7169, 7321, 10627, 10588, 7301, 7304, 10366, 7264, 7320, 7188, 7234, 10603, 10537, 7553, 7198, 7467, 10618, 10704, 7280, 7176, 7300, 7265, 7173, 7269, 7297, 7302, 7241, 10607, 8280, 7315, 7318, 10622, 7185, 7181, 10710, 7303, 7175, 10619, 7246, 7268, 7191, 8263, 10705, 7186, 7184, 7296, 7314, 8273, 7192, 7299, 7243, 7199, 7193, 10711, 7242, 7240, 10708, 7190, 8272, 10709, 7187, 7298, 7196, 7197, 8274][::-1]
partitions_to_do = [10266]
N_JOBS = 1

def process_partition(partition_id):
    try:
        path = f"/home/mpaz/neovar/secondary/period/cached/partition_{partition_id}.parquet"
        data = pd.read_parquet(path)
               
    except FileNotFoundError:
        print(f"Partition {partition_id} not found, skipping")
    # try:
    print(f"Processing partition {partition_id}")

    print(len(data))
    periods = get_period(data, samples=125000, minpd=0.1, maxpd=1000, batchsize=400)
    periods.to_csv(f"/home/mpaz/neovar/secondary/period/out/partition_{partition_id}_periods.csv", index=True)
    # except Exception as e:
    #     print(f"Error processing partition {partition_id}: {e}")

Parallel(n_jobs=N_JOBS)(delayed(process_partition)(i) for i in partitions_to_do)

